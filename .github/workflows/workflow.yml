name: 'Continuous Integration for IBF'

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

jobs:
  detect-changes:
    runs-on: ubuntu-latest

    outputs:
      ibf-api-service: ${{ steps.filter.outputs.ibf-api-service }}
      ibf-dashboard: ${{ steps.filter.outputs.ibf-dashboard }}

    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ibf-api-service:
              - "services/API-service/**"
            ibf-dashboard:
              - "interfaces/IBF-dashboard/**"

  ibf-api-service:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.ibf-api-service == 'true' }}

    runs-on: ubuntu-latest

    environment: test

    env:
      CERTBOT_EMAIL: ${{ vars.CERTBOT_EMAIL }}
      FQDN: ${{ vars.FQDN }}
      NODE_ENV: ${{ vars.NODE_ENV }}
      ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
      SECRET: ${{ secrets.SECRET }}
      RESET_SECRET: ${{ secrets.RESET_SECRET }}
      MC_API: ${{ secrets.MC_API }}
      LOCAL_PORT_IBF_SERVICE: ${{ vars.LOCAL_PORT_IBF_SERVICE }}
      GEOSERVER_ADMIN_PASSWORD: ${{ secrets.GEOSERVER_ADMIN_PASSWORD }}
      DB_HOST: ${{ vars.DB_HOST }}
      DB_PORT: ${{ vars.DB_PORT }}
      DB_USERNAME: ${{ vars.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_DATABASE: ${{ vars.DB_DATABASE }}
      PRODUCTION_DATA_SERVER: ${{ vars.PRODUCTION_DATA_SERVER }}
      WATERPOINTDATA_TOKEN: ${{ secrets.WATERPOINTDATA_TOKEN }}
      COUNTRIES: ${{ vars.COUNTRIES }}
      DISASTER_TYPES: ${{ vars.DISASTER_TYPES }}

    strategy:
      matrix:
        node-version: [20.x]

    defaults:
      run:
        working-directory: 'services/API-service'

    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm ci --no-audit
      - run: npm run lint
      - run: npm test
      - run: docker build . --file Dockerfile --tag ibf-api-service:$(date +%s)
      - run: docker compose up -d
      - run: docker compose exec ibf-api-service npm run test:api:all

  ibf-dashboard:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.ibf-dashboard == 'true' }}

    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    defaults:
      run:
        working-directory: 'interfaces/IBF-dashboard'

    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - run: npm ci --no-audit
      - run: npm run lint
      - run: npm test
      - run: docker build . --file Dockerfile --tag ibf-dashboard:$(date +%s)

  bump-version:
    needs: [ibf-api-service, ibf-dashboard]
    if: |
      always() &&
      github.event_name == 'push'

    runs-on: ubuntu-latest

    steps:
      - name: Wait for previous workflow to complete
        uses: softprops/turnstyle@v2
        with:
          abort-after-seconds: 1800
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v4

      - name: Bump version and push tag
        uses: TriPSs/conventional-changelog-action@v5
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          git-message: 'chore(release): {version}'
          release-count: 10
