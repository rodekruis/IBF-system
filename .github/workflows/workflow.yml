name: 'Continuous Integration for IBF'

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  detect-changes:
    runs-on: ubuntu-latest

    outputs:
      ibf-api-service: ${{ steps.filter.outputs.ibf-api-service }}
      ibf-dashboard: ${{ steps.filter.outputs.ibf-dashboard }}

    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ibf-api-service:
              - "services/API-service/**"
            ibf-dashboard:
              - "interfaces/IBF-dashboard/**"
            ibf-e2e:
              - "tests/e2e/**"
            ibf-integration:
              - "tests/integration/**"

  ibf-api-service:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.ibf-api-service == 'true' }}

    runs-on: ubuntu-latest

    env:
      SECRET: ${{ secrets.SECRET }}
      MC_API: ${{ secrets.MC_API }}

    defaults:
      run:
        working-directory: 'services/API-service'

    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js version
        uses: actions/setup-node@v4
        with:
          node-version-file: './services/API-service/.node-version'
      - run: npm ci --no-audit
      - run: npm run lint
      - run: npm test

  ibf-dashboard:
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.ibf-dashboard == 'true' }}

    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: 'interfaces/IBF-dashboard'

    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js version
        uses: actions/setup-node@v4
        with:
          node-version-file: './interfaces/IBF-dashboard/.node-version'
      - run: npm ci --no-audit
      - run: npm run lint
      - run: npm test

  ibf-integration:
    needs: detect-changes
    if: ${{
      needs.detect-changes.outputs.ibf-api-service == 'true' ||
      needs.detect-changes.outputs.ibf-integration == 'true'
      }}

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Run integration test action
        uses: ./.github/actions/integration
        with:
          mailchimp-api-key: ${{ secrets.MC_API }}

  ibf-e2e:
    needs: detect-changes
    if: ${{
      needs.detect-changes.outputs.ibf-api-service == 'true' ||
      needs.detect-changes.outputs.ibf-dashboard == 'true' ||
      needs.detect-changes.outputs.ibf-e2e == 'true'
      }}

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: Run e2e test action
        uses: ./.github/actions/e2e
        with:
          mailchimp-api-key: ${{ secrets.MC_API }}

  bump-version:
    needs: [ibf-api-service, ibf-dashboard, ibf-integration, ibf-e2e]
    if: |
      always() &&
      github.event_name == 'push'

    runs-on: ubuntu-latest

    steps:
      - name: Wait for previous workflow to complete
        uses: softprops/turnstyle@v2
        with:
          abort-after-seconds: 1800
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v4

      - name: Bump version and push tag
        uses: TriPSs/conventional-changelog-action@v5
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          git-message: 'chore(release): {version}'
          release-count: 10
