services:
  ibf-api-service:
    container_name: ibf-api-service
    build:
      context: ./services/API-service
      args:
        - NODE_ENV=${NODE_ENV}
    environment:
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USERNAME=${DB_USERNAME}
      - DB_PASSWORD=${DB_PASSWORD}
      - NODE_ENV=${NODE_ENV}
      - PRODUCTION_DATA_SERVER=${PRODUCTION_DATA_SERVER}
      - SECRET=${SECRET}
      - RESET_SECRET=${RESET_SECRET}
      - WATERPOINTDATA_TOKEN=${WATERPOINTDATA_TOKEN}
      - COUNTRIES=${COUNTRIES}
      - DISASTER_TYPES=${DISASTER_TYPES}
      - DASHBOARD_URL=${DASHBOARD_URL}
      - MC_API=${MC_API}
      - MC_LIST_ID=${MC_LIST_ID}
      - MC_SEGMENTS=${MC_SEGMENTS}
      - SUPPORT_EMAIL_ADDRESS=${SUPPORT_EMAIL_ADDRESS}
      - TWILIO_SID=${TWILIO_SID}
      - TWILIO_AUTHTOKEN=${TWILIO_AUTHTOKEN}
      - TWILIO_MESSAGING_SID=${TWILIO_MESSAGING_SID}
      - EXTERNAL_API_SERVICE_URL=${EXTERNAL_API_SERVICE_URL}
      - TWILIO_WHATSAPP_NUMBER=${TWILIO_WHATSAPP_NUMBER}
      - API_SERVICE_URL=${API_SERVICE_URL}
    volumes:
      - 'api_service_node_modules:/home/ibf/api-service/node_modules'
      - ./services/API-service:/home/ibf/api-service
    networks:
      api-network:
    restart: unless-stopped

  ibf-dashboard:
    build:
      context: ./interfaces/IBF-dashboard
      args:
        - NG_CONFIGURATION=${NG_CONFIGURATION}
        - API_SERVICE_URL=${API_SERVICE_URL}
        - NG_USE_SERVICE_WORKER=${NG_USE_SERVICE_WORKER}
        - NG_GEOSERVER_URL=${NG_GEOSERVER_URL}
        - NG_IBF_SYSTEM_VERSION=${NG_IBF_SYSTEM_VERSION}
        - NG_IBF_VIDEO_GUIDE_URL=${NG_IBF_VIDEO_GUIDE_URL}
        - NG_IBF_PDF_GUIDE_URL=${NG_IBF_PDF_GUIDE_URL}
        - NG_APPLICATION_INSIGHTS_INSTRUMENTATION_KEY=${NG_APPLICATION_INSIGHTS_INSTRUMENTATION_KEY}
        - NG_APPLICATION_INSIGHTS_URL=${NG_APPLICATION_INSIGHTS_URL}
        - SUPPORT_EMAIL_ADDRESS=${SUPPORT_EMAIL_ADDRESS}
        - WHATS_NEW_URL=${WHATS_NEW_URL}
    environment:
      - NG_CONFIGURATION=${NG_CONFIGURATION}
      - API_SERVICE_URL=${API_SERVICE_URL}
      - NG_USE_SERVICE_WORKER=${NG_USE_SERVICE_WORKER}
      - NG_GEOSERVER_URL=${NG_GEOSERVER_URL}
      - NG_IBF_SYSTEM_VERSION=${NG_IBF_SYSTEM_VERSION}
      - NG_IBF_VIDEO_GUIDE_URL=${NG_IBF_VIDEO_GUIDE_URL}
      - NG_IBF_PDF_GUIDE_URL=${NG_IBF_PDF_GUIDE_URL}
      - NG_APPLICATION_INSIGHTS_INSTRUMENTATION_KEY=${NG_APPLICATION_INSIGHTS_INSTRUMENTATION_KEY}
      - NG_APPLICATION_INSIGHTS_URL=${NG_APPLICATION_INSIGHTS_URL}
      - SUPPORT_EMAIL_ADDRESS=${SUPPORT_EMAIL_ADDRESS}
      - WHATS_NEW_URL=${WHATS_NEW_URL}
    volumes:
      - ./interfaces/IBF-dashboard/node_modules:/home/node/app/node_modules
      - ./interfaces/IBF-dashboard/www:/home/node/app/www

  ibf-geoserver:
    container_name: ibf-geoserver
    image: kartoza/geoserver:2.19.2
    environment:
      - GEOSERVER_ADMIN_PASSWORD=${GEOSERVER_ADMIN_PASSWORD}
      - JAVA_OPTS="-DALLOW_ENV_PARAMETRIZATION=true"
    volumes:
      - ./services/API-service/geoserver-volume/raster-files:/opt/geoserver/data_dir/workspaces/ibf-system/ibf-pipeline
      - ./services/API-service/geoserver-volume/geoserver-layers:/opt/geoserver/data_dir/workspaces/ibf-system
      - ./.env:/opt/geoserver/data_dir/geoserver-environment.properties
    networks:
      api-network:
    restart: unless-stopped

volumes:
  api_service_node_modules:

networks:
  api-network:
    driver: bridge
