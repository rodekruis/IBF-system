FROM node:17-alpine

RUN apk update && apk add python3 make g++ git

RUN mkdir -p /home/node/app/node_modules && mkdir -p /home/node/app/www && chown -R node:node /home/node/app

WORKDIR /home/node/app

COPY package*.json ./

USER node

RUN npm ci --no-audit

COPY --chown=node:node . .

EXPOSE 4200

ARG NG_CONFIGURATION
ENV NG_CONFIGURATION=$NG_CONFIGURATION

ARG NG_API_URL
ENV NG_API_URL=$NG_API_URL

ARG NG_USE_SERVICE_WORKER
ENV NG_USE_SERVICE_WORKER=$NG_USE_SERVICE_WORKER

ARG NG_GEOSERVER_URL
ENV NG_GEOSERVER_URL=$NG_GEOSERVER_URL

ARG NG_IBF_SYSTEM_VERSION
ENV NG_IBF_SYSTEM_VERSION=$NG_IBF_SYSTEM_VERSION

ARG NG_IBF_VIDEO_GUIDE_URL
ENV NG_IBF_VIDEO_GUIDE_URL=$NG_IBF_VIDEO_GUIDE_URL

ARG NG_APPLICATION_INSIGHTS_INSTRUMENTATION_KEY
ENV NG_APPLICATION_INSIGHTS_INSTRUMENTATION_KEY=$NG_APPLICATION_INSIGHTS_INSTRUMENTATION_KEY

ARG NG_APPLICATION_INSIGHTS_URL
ENV NG_APPLICATION_INSIGHTS_URL=$NG_APPLICATION_INSIGHTS_URL

ARG SUPPORT_EMAIL_ADDRESS
ENV SUPPORT_EMAIL_ADDRESS=$SUPPORT_EMAIL_ADDRESS

RUN npm run build -- --prod --configuration $NG_CONFIGURATION
