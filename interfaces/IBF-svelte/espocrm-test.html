<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EspoCRM IBF Dashboard Integration Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .iframe-container {
            border: 2px solid #007bff;
            border-radius: 8px;
            overflow: hidden;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: none;
        }
        .token-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        button {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>EspoCRM IBF Dashboard Integration Test</h1>
    
    <div class="info">
        <h3>üîß Setup Instructions</h3>
        <ol>
            <li>Replace <code>YOUR_IBF_DASHBOARD_URL</code> below with your actual IBF dashboard URL</li>
            <li>Replace <code>YOUR_ESPOCRM_API_URL</code> in the IBF dashboard environment with your EspoCRM API URL</li>
            <li>Ensure your EspoCRM API accepts Bearer token authentication</li>
            <li>Test the integration using the form below</li>
        </ol>
    </div>

    <div class="test-section">
        <h2>üìã Test Authentication Flow</h2>
        <p>Enter an EspoCRM user token and user ID to test the authentication integration:</p>
        
        <input 
            type="text" 
            id="tokenInput" 
            class="token-input" 
            placeholder="Enter EspoCRM user token (e.g., your-auth-token-here)"
            value="">
        
        <input 
            type="text" 
            id="userIdInput" 
            class="token-input" 
            placeholder="Enter EspoCRM user ID (e.g., 614da7c0e68dba891)"
            value="">
        
        <button onclick="loadDashboardWithToken()">Load Dashboard with Token & User ID</button>
        <button onclick="loadDashboardWithoutToken()">Load Dashboard without Token</button>
        
        <div id="status"></div>
    </div>

    <div class="test-section">
        <h2>üñ•Ô∏è IBF Dashboard Preview</h2>
        <div class="iframe-container">
            <iframe 
                id="dashboardFrame" 
                src="about:blank"
                title="IBF Dashboard">
            </iframe>
        </div>
    </div>

    <div class="test-section">
        <h2>üìù Integration Code Examples</h2>
        
        <h3>EspoCRM Dashlet JavaScript (client/custom/src/views/dashlets/ibf-dashboard.js)</h3>
        <pre><code>loadDashboard: function () {
    this.getUserToken().then(token => {
        const dashboardUrl = 'YOUR_IBF_DASHBOARD_URL';
        const iframeUrl = `${dashboardUrl}?espoToken=${token}`;
        
        const iframe = this.$el.find('#ibf-dashboard-frame');
        iframe.attr('src', iframeUrl);
    });
}</code></pre>

        <h3>URL Parameters</h3>
        <pre><code>// Basic token and user ID parameters
https://your-ibf-dashboard.com?espoToken=abc123token&espoUserId=614da7c0e68dba891

// Alternative parameter names
https://your-ibf-dashboard.com?token=abc123token&userId=614da7c0e68dba891

// With additional parameters
https://your-ibf-dashboard.com?espoToken=abc123token&espoUserId=614da7c0e68dba891&country=ETH&disaster=drought</code></pre>

        <h3>EspoCRM API Validation Endpoints</h3>
        <pre><code>// Primary validation endpoint (user-specific)
GET /api/v1/Preferences/{userId}
Authorization: Bearer {token}

// Fallback for additional user details
GET /api/v1/User/{userId}
Authorization: Bearer {token}

Response from Preferences:
{
  "assignedUserName": "john.doe",
  // ... other preference data
}

Response from User (if accessible):
{
  "id": "614da7c0e68dba891",
  "userName": "john.doe",
  "firstName": "John",
  "lastName": "Doe",
  "emailAddress": "john.doe@example.com"
}</code></pre>
    </div>

    <script>
        // Configuration - Update these URLs for your environment
        const IBF_DASHBOARD_URL = 'http://localhost:5173'; // Replace with your IBF dashboard URL
        const ESPOCRM_API_URL = 'https://your-espocrm-instance.com/api/v1'; // Replace with your EspoCRM API URL

        function loadDashboardWithToken() {
            const token = document.getElementById('tokenInput').value.trim();
            const userId = document.getElementById('userIdInput').value.trim();
            
            if (!token) {
                showStatus('Please enter a token', 'error');
                return;
            }
            
            if (!userId) {
                showStatus('Please enter a user ID', 'error');
                return;
            }

            const dashboardUrl = `${IBF_DASHBOARD_URL}?espoToken=${encodeURIComponent(token)}&espoUserId=${encodeURIComponent(userId)}`;
            
            showStatus('Loading dashboard with EspoCRM token and user ID...', 'info');
            
            const iframe = document.getElementById('dashboardFrame');
            iframe.src = dashboardUrl;
            
            // Listen for iframe load events
            iframe.onload = function() {
                showStatus('‚úÖ Dashboard loaded successfully with token authentication', 'success');
            };
            
            iframe.onerror = function() {
                showStatus('‚ùå Failed to load dashboard', 'error');
            };
        }

        function loadDashboardWithoutToken() {
            const dashboardUrl = IBF_DASHBOARD_URL;
            
            showStatus('Loading dashboard without token (should prompt for login)...', 'info');
            
            const iframe = document.getElementById('dashboardFrame');
            iframe.src = dashboardUrl;
            
            iframe.onload = function() {
                showStatus('‚úÖ Dashboard loaded - should show login prompt', 'success');
            };
        }

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // Generate sample data for testing
        function generateSampleToken() {
            return 'espo_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
        }
        
        function generateSampleUserId() {
            return Math.random().toString(16).substr(2, 17); // Similar to 614da7c0e68dba891
        }

        // Initialize with sample data for testing
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('tokenInput').value = generateSampleToken();
            document.getElementById('userIdInput').value = generateSampleUserId();
            showStatus('Ready to test. Use the buttons above to load the dashboard.', 'info');
        });

        // Test token validation function (for demonstration)
        async function testTokenValidation(token, userId) {
            try {
                const response = await fetch(`${ESPOCRM_API_URL}/Preferences/${userId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const preferencesData = await response.json();
                    console.log('Token validation successful:', preferencesData);
                    return { valid: true, data: preferencesData };
                } else {
                    console.log('Token validation failed:', response.status);
                    return { valid: false, error: `HTTP ${response.status}` };
                }
            } catch (error) {
                console.error('Token validation error:', error);
                return { valid: false, error: error.message };
            }
        }
    </script>
</body>
</html>
